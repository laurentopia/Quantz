<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ETF Distribution & NAV Comparator v49 (Fixed)</title>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
	<style>
		:root { --p1: #2563eb; --p2: #db2777; --bg: #f8fafc; --txt: #334155; }
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body { font-family: system-ui, -apple-system, sans-serif; background: #eef2f6; color: var(--txt); padding: 20px; }
		.container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 25px; }
		h1 { text-align: center; margin-bottom: 25px; color: #1e293b; }
		
		/* Layout */
		.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
		.grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1.2fr; gap: 15px; align-items: end; }
		
		/* Sections */
		.panel { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
		.panel h2 { font-size: 1.1rem; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #f1f5f9; }
		.ticker-tool { background: #f1f5f9; border-color: #cbd5e1; }
		
		/* Inputs */
		label { display: block; font-size: 0.8rem; font-weight: 600; color: #64748b; margin-bottom: 4px; }
		input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-family: monospace; transition: 0.3s; }
		
		/* Dynamic Input Coloring */
		input.bad-val { border-color: #fca5a5; background-color: #fef2f2; color: #dc2626; font-weight: bold; }
		input.good-val { border-color: #86efac; background-color: #f0fdf4; color: #16a34a; font-weight: bold; }

		/* Buttons */
		button { width: 100%; padding: 10px; border: none; border-radius: 4px; color: white; font-weight: 600; cursor: pointer; transition: 0.2s; }
		button:disabled { background: #94a3b8 !important; cursor: wait; }
		.btn-1 { background: var(--p1); } .btn-1:hover { background: #1d4ed8; }
		.btn-2 { background: var(--p2); } .btn-2:hover { background: #be185d; }
		.quick-btn { background: #64748b; font-size: 0.75rem; padding: 4px 12px; width: auto; }
		.quick-btn:hover { background: #475569; }
		.quick-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 15px; }

		/* Chart */
		.chart-box { position: relative; height: 500px; margin-bottom: 25px; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; }

		/* Summary */
		.sum-box { text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
		.big-num { font-size: 1.4rem; font-weight: 700; margin: 5px 0; color: #0f172a; }
		.sub-txt { font-size: 0.85rem; color: #64748b; }
		.delta-grid { display: grid; grid-template-columns: repeat(3, 1fr); text-align: center; gap: 10px; }
		
		/* Colors */
		.c1 { color: var(--p1); } .c2 { color: var(--p2); }
		.bad { color: #dc2626; font-weight: bold; } .good { color: #16a34a; font-weight: bold; }

		/* Misc */
		.loading { font-size: 0.9rem; color: var(--p1); margin-top: 5px; font-weight: 600; }
		.error { color: #dc2626; font-size: 0.9rem; margin-top: 5px; }
		.analysis-res { margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 0.85rem; border: 1px solid #cbd5e1; }
		.res-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
	</style>
</head>
<body>

<div class="container">
	<h1>ETF Distribution & NAV Comparator v49</h1>

	<!-- ANALYSIS TOOL -->
	<div class="panel ticker-tool">
		<div class="grid-4">
			<div><label>Ticker</label><input type="text" id="ticker" value="QQQ"></div>
			<div><label>Start (1 Year Ago)</label><input type="date" id="start-date"></div>
			<div><label>End (Today)</label><input type="date" id="end-date"></div>
			<div style="display:flex; gap:10px;">
				<button class="btn-1" id="btn-1" onclick="runAnalysis(1)">Analyze &rarr; ETF 1</button>
				<button class="btn-2" id="btn-2" onclick="runAnalysis(2)">Analyze &rarr; ETF 2</button>
			</div>
		</div>
		<div id="status-msg"></div>
		
		<!-- PRESETS -->
		<div class="quick-bar">
			<button class="quick-btn" onclick="setT('ORR')">ORR</button>
			<button class="quick-btn" onclick="setT('TSYY')">TSYY</button>
			<button class="quick-btn" onclick="setT('TSYY')">ULTY</button>
			<button class="quick-btn" onclick="setT('KYLD')">KYLD</button>
			<button class="quick-btn" onclick="setT('QQQI')">QQQI</button>
			<button class="quick-btn" onclick="setT('MSTY')">MSTY</button>
			<button class="quick-btn" onclick="setT('NVDY')">NVDY</button>
			<button class="quick-btn" onclick="setT('JEPY')">JEPY</button>
		</div>
	</div>

	<!-- SETTINGS -->
	<div class="panel" style="display:flex; justify-content:center; gap:20px; align-items:center;">
		<div><label>Initial Investment ($)</label><input type="number" id="invest" value="10000" style="width:120px"></div>
		<div><label>Projection Weeks</label><input type="number" id="weeks" value="52" style="width:80px"></div>
		<div style="display:flex; align-items:center; gap:5px; padding-top:18px;">
			<input type="checkbox" id="hist" style="width:auto;"> <label for="hist" style="margin:0; cursor:pointer;">Show History</label>
		</div>
	</div>

	<!-- INPUTS -->
	<div class="grid-2">
		<!-- ETF 1 -->
		<div class="panel">
			<h2 class="c1" id="h-1">ETF 1</h2>
			<div class="grid-2">
				<div>
					<label>NAV Decay (%/wk)</label><input type="number" id="n-dec-1" value="0.5" step="0.001">
					<label>NAV Decay Accel (%/wk²)</label><input type="number" id="n-acc-1" value="0.0" step="0.00001">
				</div>
				<div>
					<label>Yield Rate (%/pay)</label><input type="number" id="y-rat-1" value="1.0" step="0.001">
					<label>Yield Decay (%/wk)</label><input type="number" id="y-dec-1" value="0.0" step="0.001">
					<label>Yield Decay Accel (%/wk²)</label><input type="number" id="y-acc-1" value="0.0" step="0.00001">
				</div>
			</div>
			<div style="margin-top:10px; font-size:0.8rem; color:#666;" id="meta-1">Freq: Weekly</div>
		</div>

		<!-- ETF 2 -->
		<div class="panel">
			<h2 class="c2" id="h-2">ETF 2</h2>
			<div class="grid-2">
				<div>
					<label>NAV Decay (%/wk)</label><input type="number" id="n-dec-2" value="0.1" step="0.001">
					<label>NAV Decay Accel (%/wk²)</label><input type="number" id="n-acc-2" value="0.0" step="0.00001">
				</div>
				<div>
					<label>Yield Rate (%/pay)</label><input type="number" id="y-rat-2" value="0.5" step="0.001">
					<label>Yield Decay (%/wk)</label><input type="number" id="y-dec-2" value="0.0" step="0.001">
					<label>Yield Decay Accel (%/wk²)</label><input type="number" id="y-acc-2" value="0.0" step="0.00001">
				</div>
			</div>
			<div style="margin-top:10px; font-size:0.8rem; color:#666;" id="meta-2">Freq: Weekly</div>
		</div>
	</div>

	<!-- CHART -->
	<div class="chart-box">
		<canvas id="chart"></canvas>
	</div>

	<!-- SUMMARY -->
	<div class="grid-2">
		<div class="sum-box">
			<h3 class="c1" id="t-1">ETF 1</h3>
			<div class="sub-txt">Principal (No DRIP): <span id="v-nav-1" style="font-weight:bold; color:#333">$-</span></div>
			<div class="sub-txt">Total Income: <span id="v-inc-1">$-</span></div>
			<div style="border-top:1px dashed #ddd; margin-top:5px; padding-top:5px;">
				<div class="sub-txt">DRIP Value:</div>
				<div class="big-num" id="v-drip-1">$-</div>
			</div>
		</div>
		<div class="sum-box">
			<h3 class="c2" id="t-2">ETF 2</h3>
			<div class="sub-txt">Principal (No DRIP): <span id="v-nav-2" style="font-weight:bold; color:#333">$-</span></div>
			<div class="sub-txt">Total Income: <span id="v-inc-2">$-</span></div>
			<div style="border-top:1px dashed #ddd; margin-top:5px; padding-top:5px;">
				<div class="sub-txt">DRIP Value:</div>
				<div class="big-num" id="v-drip-2">$-</div>
			</div>
		</div>
	</div>

	<div class="panel" style="margin-top:20px; background:#f0fdf4; border-color:#bbf7d0;">
		<h3 style="text-align:center; color:#166534; margin-bottom:10px;">Comparison (ETF 1 vs ETF 2)</h3>
		<div class="delta-grid">
			<div><div class="sub-txt">Income</div><div class="big-num" id="d-inc">0%</div></div>
			<div><div class="sub-txt">Principal</div><div class="big-num" id="d-nav">0%</div></div>
			<div><div class="sub-txt">DRIP</div><div class="big-num" id="d-drip">0%</div></div>
		</div>
	</div>

	<div style="text-align:center; margin-top:20px;">
		<button class="btn-1" style="width:auto; padding:8px 20px;" onclick="share()">Copy Share Link</button>
		<div id="share-msg" style="height:20px; color:var(--p1); font-size:0.9rem;"></div>
	</div>

</div>

<script>
	// --- GLOBALS ---
	let chart;
	let H = { 1: null, 2: null }; 
	let C = {
		1: { name:'ETF 1', int:1, unit:'week' },
		2: { name:'ETF 2', int:1, unit:'week' }
	};

	// --- CHART ---
	const ctx = document.getElementById('chart').getContext('2d');
	chart = new Chart(ctx, {
		type: 'line',
		data: { labels: [], datasets: [] },
		options: {
			responsive: true,
			maintainAspectRatio: false,
			interaction: { mode: 'index', intersect: false },
			plugins: {
				legend: { position: 'top' },
				tooltip: {
					callbacks: {
						title: c => `Week ${c[0].label}`,
						label: c => `${c.dataset.label}: $${c.parsed.y.toLocaleString(undefined,{minimumFractionDigits:2})}`
					}
				},
				annotation: { annotations: {
					hist: { type:'box', xMin:-Infinity, xMax:0, backgroundColor:'rgba(255,235,59,0.1)', borderWidth:0, label:{display:true, content:'History', position:'start', yAdjust:-20, color:'#b45309'} },
					now: { type:'line', xMin:0, xMax:0, borderColor:'#64748b', borderWidth:2, borderDash:[5,5] }
				}}
			},
			scales: {
				x: { title: {display:true, text:'Weeks (0 = Today)'}, grid:{color:c=>c.tick.value===0?'#94a3b8':'#e2e8f0'} },
				y: { title: {display:true, text:'Value ($)'}, min:0 }
			}
		}
	});

	// --- MATH ---
	function getSlope(data) {
		const n = data.length;
		if (n < 2) return 0;
		let sumX=0, sumY=0, sumXY=0, sumXX=0;
		for (let p of data) {
			sumX += p.x; sumY += p.y;
			sumXY += (p.x * p.y); sumXX += (p.x * p.x);
		}
		return (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
	}

	function setT(t) { document.getElementById('ticker').value = t; }

	// --- NETWORK ---
	async function getYahoo(sym, start, end) {
		const p1 = Math.floor(new Date(start).getTime()/1000);
		const p2 = Math.floor(new Date(end).getTime()/1000) + 86400;
		const url = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}?period1=${p1}&period2=${p2}&interval=1wk&events=div`;
		
		const proxies = [
			u => `https://corsproxy.io/?${encodeURIComponent(u)}`,
			u => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}`
		];

		for (let fn of proxies) {
			try {
				const r = await fetch(fn(url));
				if (!r.ok) continue;
				const json = await r.json();
				const data = json.contents ? JSON.parse(json.contents) : json;
				if (data.chart && data.chart.result) return data.chart.result[0];
			} catch (e) {}
		}
		throw new Error("Data fetch failed. Try again.");
	}

	// --- ANALYSIS ---
	async function runAnalysis(id) {
		const sym = document.getElementById('ticker').value.toUpperCase();
		const sDate = document.getElementById('start-date').value;
		const eDate = document.getElementById('end-date').value;
		const msg = document.getElementById('status-msg');
		const btns = [document.getElementById('btn-1'), document.getElementById('btn-2')];

		if(!sym || !sDate || !eDate) return alert("Please check inputs");
		
		msg.innerHTML = `<div class="loading">Analyzing ${sym}...</div>`;
		btns.forEach(b => b.disabled = true);

		try {
			const res = await getYahoo(sym, sDate, eDate);
			
			const closes = res.indicators.quote[0].close;
			const times = res.timestamp;
			const P = [], T = [];
			
			// Clean Data
			closes.forEach((c, i) => { if(c !== null && c > 0) { P.push(c); T.push(times[i]); } });

			if(P.length < 5) throw new Error('Insufficient data points');

			// 1. NAV Decay (Logarithmic Geometric Mean)
			let logReturns = [];
			let sumRet = 0;
			const tStart = T[0];

			for(let i=1; i<P.length; i++) {
				const r = Math.log(P[i] / P[i-1]);
				sumRet += r;
				const x = (T[i] - tStart) / 604800; // weeks
				logReturns.push({x, y: r});
			}

			// Base Decay on Average Weekly Log Return (Most robust for volatile assets)
			const avgNavDecay = -1 * (sumRet / logReturns.length);
			
			// Calculate Slope just for stats display (Acceleration)
			const slope = getSlope(logReturns);
			const navAccel = -1 * slope;

			// 2. Yield Analysis
			let rawDivs = [];
			if (res.events && res.events.dividends) {
				rawDivs = Object.values(res.events.dividends).sort((a,b) => a.date - b.date);
			}

			let yields = []; 
			let intervals = [];
			
			if (rawDivs.length > 0) {
				for(let i=0; i<rawDivs.length; i++) {
					const div = rawDivs[i];
					// Find Price just before or at dividend date
					const idx = T.findIndex(t => t >= div.date);
					// Use prior close if possible to get "Pre-Drop" price for accurate yield %
					const p = (idx > 0) ? P[idx-1] : (idx > -1 ? P[idx] : P[P.length-1]);
					
					if (p > 0) {
						const y = div.amount / p;
						yields.push({ t: div.date, y: y });
					}
					if (i > 0) intervals.push((div.date - rawDivs[i-1].date)/86400);
				}
			}

			// Frequency Detection
			let freq = 1; let unit = 'week';
			if (intervals.length > 0) {
				const avgDays = intervals.reduce((a,b)=>a+b,0) / intervals.length;
				freq = Math.max(1, Math.round(avgDays / 7));
				if (freq > 10) unit = 'quarter'; else if (freq >= 3) unit = 'month'; else if (freq >= 2) unit = 'biweek';
			}

			// Yield Stats
			let avgYieldRate = 0;
			let yieldDecay = 0;

			if (yields.length > 0) {
				avgYieldRate = yields.reduce((a,b)=>a+b.y,0)/yields.length;
				
				if (yields.length > 3) {
					let logYields = [];
					const tYStart = yields[0].t;
					yields.forEach(p => {
						if(p.y > 0) logYields.push({ x: (p.t - tYStart)/604800, y: Math.log(p.y) });
					});
					const slopeY = getSlope(logYields);
					yieldDecay = -slopeY;
				}
			}

			// Apply to Inputs
			// Safe Defaults: Use Average Decay/Yield. Set Acceleration to 0 to prevent wild extrapolations.
			const setV = (k, v) => document.getElementById(k).value = v;
			
			setV(`n-dec-${id}`, (avgNavDecay * 100).toFixed(4));
			setV(`n-acc-${id}`, "0.0"); // Zero out accel by default for safety
			
			setV(`y-rat-${id}`, (avgYieldRate * 100).toFixed(3));
			setV(`y-dec-${id}`, (yieldDecay * 100).toFixed(4)); 
			setV(`y-acc-${id}`, "0.0");

			document.getElementById(`meta-${id}`).innerText = `Freq: Every ~${freq} wks (${unit})`;
			document.getElementById(`h-${id}`).innerText = sym;
			
			C[id].name = sym; C[id].int = freq; C[id].unit = unit;
			H[id] = { prices: P, times: T, divs: rawDivs }; 

			const fmt = (n, inv=false) => {
				const s = (n*100).toFixed(4) + '%';
				const isBad = inv ? n < 0 : n > 0; // Decay > 0 is bad. Yield < 0 is bad.
				return `<span class="${isBad?'bad':'good'}">${s}</span>`;
			};
			
			msg.innerHTML = `
				<div class="analysis-res">
					<strong>${sym} Stats (${P.length} wks)</strong>
					<div class="res-row"><span>Avg NAV Decay:</span> ${fmt(avgNavDecay)}</div>
					<div class="res-row"><span>NAV Decay Trend:</span> ${fmt(navAccel)}</div>
					<hr>
					<div class="res-row"><span>Avg Yield:</span> ${fmt(avgYieldRate, true)}</div>
					<div class="res-row"><span>Yield Trend:</span> ${fmt(yieldDecay)}</div>
				</div>
			`;

			calculate();

		} catch (e) {
			console.error(e);
			msg.innerHTML = `<div class="error">${e.message}</div>`;
		} finally {
			btns.forEach(b => b.disabled = false);
		}
	}

	// --- PROJECTION ---
	function calculate() {
		const inv = parseFloat(document.getElementById('invest').value) || 10000;
		const weeks = parseInt(document.getElementById('weeks').value) || 52;
		const showHist = document.getElementById('hist').checked;

		// Input coloring
		const colorize = (id) => {
			const el = document.getElementById(id);
			if(!el) return;
			const v = parseFloat(el.value);
			el.className = v > 0 ? 'bad-val' : (v < 0 ? 'good-val' : '');
		};
		for(let i=1; i<=2; i++) {
			['n-dec','n-acc','y-dec','y-acc'].forEach(k => colorize(`${k}-${i}`));
		}

		let histLen = 0;
		if (showHist) {
			const h1 = H[1]?.prices.length || 0;
			const h2 = H[2]?.prices.length || 0;
			histLen = Math.max(h1, h2); 
		}

		const labels = [];
		for(let i=-histLen; i<=weeks; i++) labels.push(i);

		const simETF = (id) => {
			const navLine = [], dripLine = [], incLine = [];
			
			const nDec = parseFloat(document.getElementById(`n-dec-${id}`).value)/100;
			const nAcc = parseFloat(document.getElementById(`n-acc-${id}`).value)/100;
			const yRat = parseFloat(document.getElementById(`y-rat-${id}`).value)/100;
			const yDec = parseFloat(document.getElementById(`y-dec-${id}`).value)/100;
			const yAcc = parseFloat(document.getElementById(`y-acc-${id}`).value)/100;
			const freq = C[id].int;

			// History
			let sharesP = 0, sharesD = 0, cash = 0, price = 0;
			let hasData = H[id] !== null;

			if (showHist && hasData) {
				const prices = H[id].prices;
				const times = H[id].times;
				const divs = H[id].divs;
				const offset = histLen - prices.length;
				
				price = prices[0];
				sharesP = inv / price;
				sharesD = inv / price;

				for(let k=0; k<offset; k++) { navLine.push(null); dripLine.push(null); incLine.push(null); }
				navLine.push(sharesP * price); dripLine.push(sharesD * price); incLine.push(0);

				for(let i=1; i<prices.length; i++) {
					price = prices[i];
					const tNow = times[i];
					const tPrev = times[i-1];
					let divAmt = 0;
					divs.forEach(d => { if(d.date > tPrev && d.date <= tNow) divAmt += d.amount; });

					if (divAmt > 0) {
						cash += (sharesP * divAmt);
						sharesD += (sharesD * divAmt) / price;
					}
					navLine.push(sharesP * price);
					dripLine.push(sharesD * price);
					incLine.push(cash);
				}
			} else {
				for(let i=0; i<histLen; i++) { navLine.push(null); dripLine.push(null); incLine.push(null); }
				price = 1.0; sharesP = inv; sharesD = inv;
				navLine.push(inv); dripLine.push(inv); incLine.push(0);
			}

			// Projection
			let yieldDecayCum = 0;

			for(let w=1; w<=weeks; w++) {
				const curNDec = nDec + (nAcc * w);
				price *= (1 - curNDec);
				if (price < 0.0001) price = 0;

				const curYDec = yDec + (yAcc * w);
				yieldDecayCum += curYDec;
				const yieldMult = Math.max(0, 1 - yieldDecayCum); 

				if (w % freq === 0 && price > 0) {
					const payPerShare = price * (yRat * yieldMult);
					cash += (sharesP * payPerShare);
					sharesD += (sharesD * payPerShare) / price;
				}

				navLine.push(sharesP * price);
				dripLine.push(sharesD * price);
				incLine.push(cash);
			}
			return { nav: navLine, drip: dripLine, inc: incLine };
		};

		const r1 = simETF(1);
		const r2 = simETF(2);

		const ds = [
			{ label:`${C[1].name} Principal`, data:r1.nav, borderColor:'#2563eb', borderWidth:2, pointRadius:0 },
			{ label:`${C[1].name} DRIP`, data:r1.drip, borderColor:'#1e40af', borderDash:[4,4], borderWidth:2, pointRadius:0 },
			{ label:`${C[1].name} Income`, data:r1.inc, borderColor:'#93c5fd', backgroundColor:'rgba(37, 99, 235, 0.1)', fill:true, pointRadius:0 },
			{ label:`${C[2].name} Principal`, data:r2.nav, borderColor:'#db2777', borderWidth:2, pointRadius:0 },
			{ label:`${C[2].name} DRIP`, data:r2.drip, borderColor:'#be185d', borderDash:[4,4], borderWidth:2, pointRadius:0 },
			{ label:`${C[2].name} Income`, data:r2.inc, borderColor:'#fbcfe8', backgroundColor:'rgba(219, 39, 119, 0.1)', fill:true, pointRadius:0 }
		];

		chart.data.labels = labels;
		chart.data.datasets = ds;
		chart.options.plugins.annotation.annotations.hist.display = showHist;
		chart.update();

		// Stats
		const end1 = { nav: r1.nav.at(-1), drip: r1.drip.at(-1), inc: r1.inc.at(-1) };
		const end2 = { nav: r2.nav.at(-1), drip: r2.drip.at(-1), inc: r2.inc.at(-1) };
		const fmt = n => '$'+Math.round(n).toLocaleString();
		
		document.getElementById('t-1').innerText = C[1].name;
		document.getElementById('v-nav-1').innerText = fmt(end1.nav);
		document.getElementById('v-inc-1').innerText = fmt(end1.inc);
		document.getElementById('v-drip-1').innerText = fmt(end1.drip);

		document.getElementById('t-2').innerText = C[2].name;
		document.getElementById('v-nav-2').innerText = fmt(end2.nav);
		document.getElementById('v-inc-2').innerText = fmt(end2.inc);
		document.getElementById('v-drip-2').innerText = fmt(end2.drip);

		const delta = (a,b) => (b===0) ? '-' : ((a/b)-1)*100 > 0 ? '+'+(((a/b)-1)*100).toFixed(1)+'%' : (((a/b)-1)*100).toFixed(1)+'%';
		document.getElementById('d-inc').innerText = delta(end1.inc, end2.inc);
		document.getElementById('d-nav').innerText = delta(end1.nav, end2.nav);
		document.getElementById('d-drip').innerText = delta(end1.drip, end2.drip);

		updateUrl();
	}

	// --- STATE ---
	function updateUrl() {
		try {
			const p = new URLSearchParams();
			p.set('t', document.getElementById('ticker').value);
			p.set('sd', document.getElementById('start-date').value);
			p.set('ed', document.getElementById('end-date').value);
			p.set('inv', document.getElementById('invest').value);
			p.set('w', document.getElementById('weeks').value);
			p.set('h', document.getElementById('hist').checked);
			[1,2].forEach(i => {
				p.set(`n${i}`, C[i].name);
				p.set(`int${i}`, C[i].int);
				['n-dec','n-acc','y-rat','y-dec','y-acc'].forEach(k => 
					p.set(`${k}${i}`, document.getElementById(`${k}-${i}`).value)
				);
			});
			history.replaceState(null, '', '?'+p.toString());
		} catch(e) {}
	}

	function loadUrl() {
		const p = new URLSearchParams(location.search);
		if(!p.has('inv')) return;
		document.getElementById('ticker').value = p.get('t') || 'TSYY';
		if(p.get('sd')) document.getElementById('start-date').value = p.get('sd');
		if(p.get('ed')) document.getElementById('end-date').value = p.get('ed');
		document.getElementById('invest').value = p.get('inv');
		document.getElementById('weeks').value = p.get('w');
		document.getElementById('hist').checked = p.get('h') === 'true';
		[1,2].forEach(i => {
			if(p.has(`n${i}`)) C[i].name = p.get(`n${i}`);
			if(p.has(`int${i}`)) C[i].int = parseInt(p.get(`int${i}`));
			['n-dec','n-acc','y-rat','y-dec','y-acc'].forEach(k => {
				if(p.has(`${k}${i}`)) document.getElementById(`${k}-${i}`).value = p.get(`${k}${i}`);
			});
		});
	}

	function share() {
		updateUrl();
		navigator.clipboard.writeText(location.href);
		document.getElementById('share-msg').innerText = 'Copied!';
		setTimeout(()=>document.getElementById('share-msg').innerText='', 1000);
	}

	function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(()=>fn(...a), ms); }; }

	// Events
	const inputs = ['invest', 'weeks', 'hist'];
	for(let i=1; i<=2; i++) inputs.push(`n-dec-${i}`, `n-acc-${i}`, `y-rat-${i}`, `y-dec-${i}`, `y-acc-${i}`);
	inputs.forEach(id => {
		const el = document.getElementById(id);
		if(el) el.addEventListener(el.type==='number'?'input':'change', debounce(calculate, 300));
	});

	// Init (Strict Order)
	document.addEventListener('DOMContentLoaded', () => {
		const d = new Date();
		const end = d.toISOString().split('T')[0];
		d.setFullYear(d.getFullYear() - 1);
		const start = d.toISOString().split('T')[0];
		
		const elS = document.getElementById('start-date');
		const elE = document.getElementById('end-date');
		
		// Only set defaults if empty (allows browser cache to persist if refreshed)
		if(!elS.value) elS.value = start;
		if(!elE.value) elE.value = end;

		loadUrl();
		calculate();
	});

</script>
</body>
</html>
