<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High Yield ETF Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .group { border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 5px; }
        input { margin: 5px; padding: 3px; }
        label { display: block; margin: 5px 0; }
        #chart { height: 400px; position: relative; margin: 20px 0; }
        #summary { margin-top: 20px; padding: 10px; background: #f9f9f9; border-radius: 5px; }
        #analyzer { border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 5px; }
        button { padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>High Yield ETF Simulator</h1>
    <p>Simulate and compare two ETFs over time (weeks). Cumulative distributions are filled areas. NAV curves are dashed thin lines. DRIP totals are solid lines (independent of yield when coupled). Totals assume $1 share initial investment scaled to initial NAV.</p>

    <div class="group">
        <h3>ETF 1</h3>
        <label>Initial NAV ($): <input id="nav1" type="number" step="0.01" value="10"></label>
        <label>NAV Decay Rate (%/week): <input id="dnav1" type="number" step="0.01" value="0.5"></label>
        <label><input id="dec1" type="checkbox"> Decoupled Distribution (absolute $/week, independent of NAV)</label>
        <div id="yielddiv1">
            <label>Distribution Yield (%/week): <input id="yield1" type="number" step="0.01" value="1"></label>
        </div>
        <div id="distdiv1" style="display: none;">
            <label>Initial Distribution ($/week): <input id="dist1" type="number" step="0.01" value="0.1"></label>
        </div>
        <label>Distribution Decay Rate (%/week): <input id="dy1" type="number" step="0.01" value="0"></label>
    </div>

    <div class="group">
        <h3>ETF 2</h3>
        <label>Initial NAV ($): <input id="nav2" type="number" step="0.01" value="10"></label>
        <label>NAV Decay Rate (%/week): <input id="dnav2" type="number" step="0.01" value="0.2"></label>
        <label><input id="dec2" type="checkbox"> Decoupled Distribution (absolute $/week, independent of NAV)</label>
        <div id="yielddiv2">
            <label>Distribution Yield (%/week): <input id="yield2" type="number" step="0.01" value="0.5"></label>
        </div>
        <div id="distdiv2" style="display: none;">
            <label>Initial Distribution ($/week): <input id="dist2" type="number" step="0.01" value="0.05"></label>
        </div>
        <label>Distribution Decay Rate (%/week): <input id="dy2" type="number" step="0.01" value="0"></label>
    </div>

    <label>Time Frame (Weeks): <input id="weeks" type="number" min="1" value="52"></label>

    <div id="chart"><canvas id="myChart"></canvas></div>

    <div id="summary"></div>

    <div id="analyzer">
        <h3>Analyze Ticker (Fills ETF 1)</h3>
        <label>Ticker: <input id="ticker" type="text" value="ULTY"></label>
        <label>Start Date: <input id="startdate" type="date" value="2024-01-01"></label>
        <label>End Date: <input id="enddate" type="date" value="2025-11-01"></label>
        <button onclick="analyze()">Analyze</button>
        <p><small>Averages NAV decay (geometric), distribution yield (total div / avg NAV / weeks). Sets dist decay to 0. Uses Yahoo Finance data.</small></p>
    </div>

    <script>
        let chart;
        const ctx = document.getElementById('myChart').getContext('2d');

        function compute(initial_nav, d_nav, initial_y, d_y, weeks, decoupled, initial_dist) {
            let navs = [initial_nav];
            let cum_dists = [0];
            let drip_totals = [initial_nav];
            let current_nav = initial_nav;
            let shares = 1.0;
            for (let t = 1; t <= weeks; t++) {
                current_nav *= (1 - d_nav);
                let y_factor = Math.pow(1 - d_y, t - 1);
                let dist_t;
                if (decoupled) {
                    dist_t = initial_dist * y_factor;
                } else {
                    let y_t = initial_y * y_factor;
                    dist_t = current_nav * y_t;
                }
                let cum_dist = cum_dists[cum_dists.length - 1] + dist_t;
                cum_dists.push(cum_dist);
                let nav_after = decoupled ? current_nav : current_nav - dist_t;
                navs.push(nav_after);
                let total_drip;
                if (decoupled) {
                    let dist_cash = dist_t;
                    let add_shares = dist_cash / nav_after;
                    shares += add_shares;
                    total_drip = shares * nav_after;
                } else {
                    total_drip = initial_nav * Math.pow(1 - d_nav, t);
                }
                drip_totals.push(total_drip);
                current_nav = nav_after;
            }
            let final_no_drip = navs[navs.length - 1] + cum_dists[cum_dists.length - 1];
            let final_drip = drip_totals[drip_totals.length - 1];
            let final_cum = cum_dists[cum_dists.length - 1];
            return { navs, cum_dists, drip_totals, final_no_drip, final_drip, final_cum_dist: final_cum };
        }

        function update() {
            const weeks = parseInt(document.getElementById('weeks').value) || 52;

            // ETF1
            const nav1 = parseFloat(document.getElementById('nav1').value) || 10;
            const dnav1 = parseFloat(document.getElementById('dnav1').value) / 100 || 0.005;
            const dec1 = document.getElementById('dec1').checked;
            let initial_y1 = dec1 ? 0 : (parseFloat(document.getElementById('yield1').value) / 100 || 0.01);
            let initial_d1 = dec1 ? (parseFloat(document.getElementById('dist1').value) || 0.1) : 0;
            const dy1 = parseFloat(document.getElementById('dy1').value) / 100 || 0;
            document.getElementById('distdiv1').style.display = dec1 ? 'block' : 'none';
            document.getElementById('yielddiv1').style.display = dec1 ? 'none' : 'block';

            // ETF2
            const nav2 = parseFloat(document.getElementById('nav2').value) || 10;
            const dnav2 = parseFloat(document.getElementById('dnav2').value) / 100 || 0.002;
            const dec2 = document.getElementById('dec2').checked;
            let initial_y2 = dec2 ? 0 : (parseFloat(document.getElementById('yield2').value) / 100 || 0.005);
            let initial_d2 = dec2 ? (parseFloat(document.getElementById('dist2').value) || 0.05) : 0;
            const dy2 = parseFloat(document.getElementById('dy2').value) / 100 || 0;
            document.getElementById('distdiv2').style.display = dec2 ? 'block' : 'none';
            document.getElementById('yielddiv2').style.display = dec2 ? 'none' : 'block';

            const res1 = compute(nav1, dnav1, initial_y1, dy1, weeks, dec1, initial_d1);
            const res2 = compute(nav2, dnav2, initial_y2, dy2, weeks, dec2, initial_d2);

            const x = Array.from({ length: weeks + 1 }, (_, i) => i);

            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: x,
                    datasets: [
                        {
                            label: 'Cum Dist ETF1',
                            data: res1.cum_dists,
                            fill: true,
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.1
                        },
                        {
                            label: 'NAV ETF1',
                            data: res1.navs,
                            borderColor: 'rgb(255, 99, 132)',
                            borderDash: [5, 5],
                            borderWidth: 1,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'DRIP Total ETF1',
                            data: res1.drip_totals,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'transparent',
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'Cum Dist ETF2',
                            data: res2.cum_dists,
                            fill: true,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgb(54, 162, 235)',
                            tension: 0.1
                        },
                        {
                            label: 'NAV ETF2',
                            data: res2.navs,
                            borderColor: 'rgb(54, 162, 235)',
                            borderDash: [5, 5],
                            borderWidth: 1,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'DRIP Total ETF2',
                            data: res2.drip_totals,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'transparent',
                            pointRadius: 0,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });

            document.getElementById('summary').innerHTML = `
                <h3>Summary at ${weeks} Weeks (Initial Investment: $${nav1.toFixed(2)} each)</h3>
                <p><strong>ETF1:</strong> Total Distributions: $${res1.final_cum_dist.toFixed(2)} | No DRIP Total Return: $${res1.final_no_drip.toFixed(2)} | Full DRIP Total Return: $${res1.final_drip.toFixed(2)}</p>
                <p><strong>ETF2:</strong> Total Distributions: $${res2.final_cum_dist.toFixed(2)} | No DRIP Total Return: $${res2.final_no_drip.toFixed(2)} | Full DRIP Total Return: $${res2.final_drip.toFixed(2)}</p>
            `;

            // Save to URL
            const params = new URLSearchParams({
                w: document.getElementById('weeks').value,
                nav1: document.getElementById('nav1').value,
                dnav1: document.getElementById('dnav1').value,
                dec1: dec1 ? '1' : '0',
                yield1: document.getElementById('yield1').value,
                dist1: document.getElementById('dist1').value,
                dy1: document.getElementById('dy1').value,
                nav2: document.getElementById('nav2').value,
                dnav2: document.getElementById('dnav2').value,
                dec2: dec2 ? '1' : '0',
                yield2: document.getElementById('yield2').value,
                dist2: document.getElementById('dist2').value,
                dy2: document.getElementById('dy2').value
            });
            history.replaceState(null, '', '?' + params.toString());
        }

        // Event listeners
        document.querySelectorAll('input, #dec1, #dec2').forEach(el => {
            el.addEventListener('input', update);
            el.addEventListener('change', update);
        });

        // Load from URL
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const fields = ['weeks', 'nav1', 'dnav1', 'yield1', 'dist1', 'dy1', 'nav2', 'dnav2', 'yield2', 'dist2', 'dy2'];
            fields.forEach(f => {
                if (params.has(f)) document.getElementById(f).value = params.get(f);
            });
            if (params.get('dec1') === '1') document.getElementById('dec1').checked = true;
            if (params.get('dec2') === '1') document.getElementById('dec2').checked = true;
            update();
        });

        // Analyze
        async function analyze() {
            const ticker = document.getElementById('ticker').value.toUpperCase().trim();
            const start = document.getElementById('startdate').value;
            const end = document.getElementById('enddate').value;
            if (!ticker || !start || !end) return alert('Please fill ticker and dates.');
            const startUnix = Math.floor(new Date(start).getTime() / 1000);
            const endUnix = Math.floor(new Date(end).getTime() / 1000);
            const proxy = 'https://api.allorigins.win/raw?url=';
            try {
                // Price history
                let priceUrl = encodeURIComponent(`https://query1.finance.yahoo.com/v7/finance/download/${ticker}?period1=${startUnix}&period2=${endUnix}&interval=1wk&events=history&includeAdjustedClose=true`);
                const priceResp = await fetch(proxy + priceUrl);
                if (!priceResp.ok) throw new Error('Price fetch failed');
                const priceText = await priceResp.text();
                const priceLines = priceText.split('\n').filter(l => l.trim()).slice(1);
                let navs = [];
                priceLines.forEach(line => {
                    const parts = line.split(',');
                    const adj = parseFloat(parts[6]);
                    if (!isNaN(adj) && adj > 0) navs.push(adj);
                });
                if (navs.length < 2) throw new Error('Insufficient price data');

                let log_returns = [];
                for (let i = 1; i < navs.length; i++) {
                    log_returns.push(Math.log(navs[i] / navs[i - 1]));
                }
                const avg_log_r = log_returns.reduce((a, b) => a + b, 0) / log_returns.length;
                const d_nav_pct = (-avg_log_r * 100).toFixed(4);
                const initial_nav_val = navs[0].toFixed(2);

                // Dividends
                let divUrl = encodeURIComponent(`https://query1.finance.yahoo.com/v7/finance/download/${ticker}?period1=${startUnix}&period2=${endUnix}&interval=1d&events=div&includeAdjustedClose=true`);
                const divResp = await fetch(proxy + divUrl);
                if (!divResp.ok) throw new Error('Div fetch failed');
                const divText = await divResp.text();
                const divLines = divText.split('\n').filter(l => l.trim()).slice(1);
                let total_div = 0;
                divLines.forEach(line => {
                    const parts = line.split(',');
                    const close = parseFloat(parts[4]); // Dividend amount in Close
                    if (!isNaN(close) && close > 0) total_div += close;
                });

                const num_weeks = navs.length - 1;
                const avg_weekly_dist = total_div / num_weeks;
                const avg_nav = navs.reduce((a, b) => a + b, 0) / navs.length;
                const avg_yield_pct = (avg_weekly_dist / avg_nav * 100).toFixed(4);

                // Fill ETF1 (coupled)
                document.getElementById('nav1').value = initial_nav_val;
                document.getElementById('dnav1').value = d_nav_pct;
                document.getElementById('dec1').checked = false;
                document.getElementById('yield1').value = avg_yield_pct;
                document.getElementById('dy1').value = '0';
                document.getElementById('distdiv1').style.display = 'none';
                document.getElementById('yielddiv1').style.display = 'block';
                update();
                alert(`ETF1 filled: NAV $${initial_nav_val}, Decay ${d_nav_pct}%, Yield ${avg_yield_pct}%/week, Dist Decay 0%`);
            } catch (e) {
                alert('Error fetching data: ' + e.message + '. Check ticker/dates or network.');
            }
        }
    </script>
</body>
</html>
