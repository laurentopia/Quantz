<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ETF Distribution & NAV Comparator v20</title>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
			background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
			min-height: 100vh;
			padding: 20px;
			color: #333;
		}
		.container {
			max-width: 1400px;
			margin: 0 auto;
			background: white;
			border-radius: 12px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.1);
			padding: 25px;
		}
		h1 { text-align: center; margin-bottom: 25px; color: #2c3e50; }
		
		/* Ticker Tool */
		.ticker-tool { background: #eef2f7; padding: 20px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #d1d9e6; }
		.ticker-inputs { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; align-items: end; }
		.quick-tickers { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
		.quick-tickers button { 
			padding: 4px 10px; font-size: 11px; background: #5c6c7f; color: white; border: none; border-radius: 4px; cursor: pointer; transition: 0.2s;
		}
		.quick-tickers button:hover { background: #475569; }
		
		/* Controls */
		.controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
		.etf-panel { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
		.etf-panel h2 { margin-bottom: 15px; font-size: 1.2rem; border-bottom: 2px solid #eee; padding-bottom: 5px; }
		
		/* Inputs */
		.input-group { margin-bottom: 12px; }
		label { display: block; font-size: 0.85rem; font-weight: 600; color: #64748b; margin-bottom: 4px; }
		input[type="text"], input[type="number"], input[type="date"] {
			width: 100%; padding: 8px 10px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.95rem;
		}
		
		/* Timeframe & Invest */
		.global-settings { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; align-items: center; }
		.global-settings .input-group { margin-bottom: 0; width: 180px; }
		
		.toggle-history { display: flex; align-items: center; gap: 10px; background: #fff9c4; padding: 8px 15px; border-radius: 6px; border: 1px solid #fdd835; }
		.toggle-history label { margin: 0; color: #856404; cursor: pointer; display: flex; align-items: center; gap: 5px; }

		/* Chart */
		.chart-container { position: relative; height: 550px; margin-bottom: 25px; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; background: white; }
		
		/* Summary */
		.summary { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
		.summary-box { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center; }
		.summary-value { font-size: 1.5rem; font-weight: 700; color: #2c3e50; margin: 5px 0; }
		.summary-sub { font-size: 0.9rem; color: #64748b; margin: 2px 0; }
		
		/* Delta */
		.delta-comparison { margin-top: 15px; background: #f0fdf4; border: 1px solid #bbf7d0; padding: 15px; border-radius: 8px; }
		.delta-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; }
		
		/* Buttons */
		.btn-primary { background: #3b82f6; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; transition: 0.2s; }
		.btn-primary:hover:not(:disabled) { background: #2563eb; }
		.btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }
		
		.apply-buttons { display: flex; gap: 10px; margin-top: 10px; }
		
		/* Utilities */
		.hidden { display: none; }
		.error { color: #ef4444; font-size: 0.9rem; margin-top: 5px; }
		.loading { color: #3b82f6; font-size: 0.9rem; margin-top: 5px; }
		.analysis-results { background: white; padding: 10px; border: 1px solid #e2e8f0; border-radius: 4px; margin-top: 10px; font-size: 0.85rem; }
		.metric-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
		
		.history-badge { background: #fff9c4; color: #856404; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; border: 1px solid #fdd835; display: inline-block; margin-top: 5px;}
	</style>
</head>
<body>

<div class="container">
	<h1>ETF Distribution & NAV Comparator v20</h1>

	<div class="ticker-tool">
		<h3>1. Analyze Historical Data (Yahoo Finance)</h3>
		<div class="ticker-inputs">
			<div class="input-group">
				<label>Ticker</label>
				<input type="text" id="ticker" placeholder="JEPY">
			</div>
			<div class="input-group">
				<label>Start Date</label>
				<input type="date" id="start-date">
			</div>
			<div class="input-group">
				<label>End Date</label>
				<input type="date" id="end-date">
			</div>
			<div class="input-group">
				<label>&nbsp;</label>
				<button class="btn-primary" id="analyze-btn" onclick="analyzeTicker()">Analyze</button>
			</div>
		</div>
		<div id="ticker-status"></div>
		
		<div class="quick-tickers">
			<button onclick="setTicker('JEPY')">JEPY</button>
			<button onclick="setTicker('QQQY')">QQQY</button>
			<button onclick="setTicker('JEPI')">JEPI</button>
			<button onclick="setTicker('SPYI')">SPYI</button>
			<button onclick="setTicker('QQQI')">QQQI</button>
			<button onclick="setTicker('MAIN')">MAIN</button>
			<button onclick="setTicker('TSYY')">TSYY</button>
			<button onclick="setTicker('HOOW')">HOOW</button>
			<button onclick="setTicker('ULTY')">ULTY</button>
			<button onclick="setTicker('BLOX')">BLOX</button>
			<button onclick="setTicker('KYLD')">KYLD</button>
			<button onclick="setTicker('ULTI')">ULTI</button>
		</div>

		<div class="apply-buttons">
			<button class="btn-primary" id="apply-1" disabled onclick="applyToETF(1)">Apply to ETF 1</button>
			<button class="btn-primary" id="apply-2" disabled onclick="applyToETF(2)">Apply to ETF 2</button>
		</div>
	</div>

	<div class="global-settings">
		<div class="input-group">
			<label>Initial Investment ($)</label>
			<input type="number" id="initial-investment" value="10000" step="100">
		</div>
		<div class="input-group">
			<label>Projection Weeks</label>
			<input type="number" id="timeframe" value="52">
		</div>
		<div class="toggle-history">
			<input type="checkbox" id="show-history">
			<label for="show-history">Show Historical Backtest<br><small>(Starts at Initial Inv.)</small></label>
		</div>
	</div>
	
	<div id="history-warning" class="error" style="text-align: center; display: none; margin-bottom: 20px;">
		⚠️ History enabled but no data loaded. Use "Analyze Ticker" first.
	</div>

	<div class="controls">
		<div class="etf-panel">
			<h2 id="etf1-name">ETF 1</h2>
			<div class="input-group">
				<label><input type="checkbox" id="etf1-decouple"> Decouple Yield from NAV</label>
			</div>
			<div class="input-group">
				<label>NAV Decay (%/week)</label>
				<input type="number" id="etf1-nav-decay" value="0.5" step="0.001">
			</div>
			<div class="input-group" id="etf1-rate-wrap">
				<label>Dist Rate (%/week)</label>
				<input type="number" id="etf1-dist-rate" value="2.0" step="0.001">
			</div>
			<div class="input-group hidden" id="etf1-abs-wrap">
				<label>Abs Dist (%/week)</label>
				<input type="number" id="etf1-abs-dist" value="2.0" step="0.001">
			</div>
			<div class="input-group">
				<label>Yield Decay (%/week)</label>
				<input type="number" id="etf1-dist-decay" value="0.1" step="0.001">
			</div>
		</div>

		<div class="etf-panel">
			<h2 id="etf2-name">ETF 2</h2>
			<div class="input-group">
				<label><input type="checkbox" id="etf2-decouple"> Decouple Yield from NAV</label>
			</div>
			<div class="input-group">
				<label>NAV Decay (%/week)</label>
				<input type="number" id="etf2-nav-decay" value="0.1" step="0.001">
			</div>
			<div class="input-group" id="etf2-rate-wrap">
				<label>Dist Rate (%/week)</label>
				<input type="number" id="etf2-dist-rate" value="1.0" step="0.001">
			</div>
			<div class="input-group hidden" id="etf2-abs-wrap">
				<label>Abs Dist (%/week)</label>
				<input type="number" id="etf2-abs-dist" value="1.0" step="0.001">
			</div>
			<div class="input-group">
				<label>Yield Decay (%/week)</label>
				<input type="number" id="etf2-dist-decay" value="0.0" step="0.001">
			</div>
		</div>
	</div>

	<div class="chart-container">
		<canvas id="chart"></canvas>
	</div>

	<div class="summary">
		<div class="summary-box">
			<h3>ETF 1 Outcome</h3>
			<div class="summary-sub">Value @ Week 0 (Today): <span id="etf1-val-today">$-</span></div>
			<div class="summary-value" id="etf1-total-return">$-</div>
			<div class="summary-sub">Total Return (NAV + Cash)</div>
			<hr style="border:0; border-top:1px solid #eee; margin: 10px 0;">
			<div class="summary-sub">Final NAV: <span id="etf1-final-nav">$-</span></div>
			<div class="summary-sub">Total Income: <span id="etf1-total-inc">$-</span></div>
			<div class="summary-sub">DRIP Value: <span id="etf1-drip">$-</span></div>
		</div>
		<div class="summary-box">
			<h3>ETF 2 Outcome</h3>
			<div class="summary-sub">Value @ Week 0 (Today): <span id="etf2-val-today">$-</span></div>
			<div class="summary-value" id="etf2-total-return">$-</div>
			<div class="summary-sub">Total Return (NAV + Cash)</div>
			<hr style="border:0; border-top:1px solid #eee; margin: 10px 0;">
			<div class="summary-sub">Final NAV: <span id="etf2-final-nav">$-</span></div>
			<div class="summary-sub">Total Income: <span id="etf2-total-inc">$-</span></div>
			<div class="summary-sub">DRIP Value: <span id="etf2-drip">$-</span></div>
		</div>
	</div>

	<div class="delta-comparison">
		<h3 style="text-align: center; margin-bottom: 10px; color:#166534">Comparison (ETF 1 vs ETF 2)</h3>
		<div class="delta-grid">
			<div>
				<div class="summary-sub">Total Income</div>
				<div class="summary-value" id="delta-inc" style="font-size: 1.2rem;">0%</div>
			</div>
			<div>
				<div class="summary-sub">Total Return</div>
				<div class="summary-value" id="delta-ret" style="font-size: 1.2rem;">0%</div>
			</div>
			<div>
				<div class="summary-sub">DRIP Value</div>
				<div class="summary-value" id="delta-drip" style="font-size: 1.2rem;">0%</div>
			</div>
		</div>
	</div>

	<div style="text-align: center; margin-top: 30px;">
		<button class="btn-primary" style="width: auto; background: #10b981;" onclick="shareUrl()">Copy Share URL</button>
		<div id="share-msg" style="margin-top:5px; height: 20px; color: #10b981;"></div>
	</div>

</div>

<script>
	// --- State & Config ---
	let chart;
	let histData = { etf1: null, etf2: null }; // Stores { prices: [], divs: [{date, amount}] }
	let etfConfig = {
		etf1: { name: 'ETF 1', interval: 1, unit: 'week' },
		etf2: { name: 'ETF 2', interval: 1, unit: 'week' }
	};
	let analysisTemp = null; // Temp holder for analysis result

	// Colors
	const C = {
		e1: { nav: '#2563eb', inc: '#93c5fd', drip: '#1e40af' }, // Blue
		e2: { nav: '#db2777', inc: '#fbcfe8', drip: '#be185d' }, // Pink
		histBg: 'rgba(255, 235, 59, 0.15)' // Yellow Overlay
	};

	// --- Chart Setup ---
	const ctx = document.getElementById('chart').getContext('2d');
	chart = new Chart(ctx, {
		type: 'line',
		data: { labels: [], datasets: [] },
		options: {
			responsive: true,
			maintainAspectRatio: false,
			interaction: { mode: 'index', intersect: false },
			plugins: {
				legend: { position: 'top' },
				tooltip: {
					callbacks: {
						title: (ctx) => {
							const w = ctx[0].label;
							return w < 0 ? `Week ${w} (History)` : `Week ${w} (Projection)`;
						},
						label: (ctx) => `${ctx.dataset.label}: $${ctx.parsed.y.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
					}
				},
				annotation: {
					annotations: {
						histZone: {
							type: 'box',
							xMin: -Infinity,
							xMax: 0,
							backgroundColor: C.histBg,
							borderWidth: 0,
							label: { display: true, content: 'Historical Backtest', position: 'start', yAdjust: -20, color: '#b45309' }
						},
						nowLine: {
							type: 'line',
							xMin: 0, xMax: 0,
							borderColor: '#64748b', borderWidth: 2, borderDash: [5,5],
							label: { display: true, content: 'Today', position: 'end', backgroundColor: '#64748b' }
						}
					}
				}
			},
			scales: {
				x: { title: { display: true, text: 'Weeks (0 = Today)' }, grid: { color: (ctx) => ctx.tick.value === 0 ? '#94a3b8' : '#e2e8f0' } },
				y: { title: { display: true, text: 'Value ($)' } }
			}
		}
	});

	// --- Networking (Proxy) ---
	const PROXIES = [
		url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
		url => `https://corsproxy.io/?${encodeURIComponent(url)}`
	];
	let proxyIdx = 0;

	async function fetchYahoo(url) {
		try {
			const res = await fetch(PROXIES[proxyIdx](url));
			if (!res.ok) throw new Error('Network err');
			return await res.json();
		} catch (e) {
			proxyIdx = (proxyIdx + 1) % PROXIES.length;
			if (proxyIdx === 0) throw e;
			return fetchYahoo(url);
		}
	}

	// --- Analysis ---
	function setTicker(t) { document.getElementById('ticker').value = t; }

	async function analyzeTicker() {
		const sym = document.getElementById('ticker').value.toUpperCase();
		const sDate = document.getElementById('start-date').value;
		const eDate = document.getElementById('end-date').value;
		const status = document.getElementById('ticker-status');
		const btns = [document.getElementById('analyze-btn'), document.getElementById('apply-1'), document.getElementById('apply-2')];

		if(!sym || !sDate || !eDate) return alert('Please fill ticker and dates');
		
		status.innerHTML = '<div class="loading">Fetching data...</div>';
		btns.forEach(b => b.disabled = true);

		try {
			const p1 = Math.floor(new Date(sDate).getTime()/1000);
			const p2 = Math.floor(new Date(eDate).getTime()/1000);
			const base = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}?period1=${p1}&period2=${p2}&interval=1wk`;
			
			const [priceData, divData] = await Promise.all([
				fetchYahoo(base),
				fetchYahoo(base + '&events=div')
			]);

			const res = priceData.chart.result[0];
			const closes = res.indicators.quote[0].close;
			const timestamps = res.timestamp;
			
			// Clean nulls
			const cleanPrices = [];
			const cleanTimes = [];
			closes.forEach((c, i) => { if(c) { cleanPrices.push(c); cleanTimes.push(timestamps[i]); } });

			if(cleanPrices.length < 5) throw new Error('Insufficient data');

			// Nav Decay
			let decaySum = 0;
			for(let i=1; i<cleanPrices.length; i++) decaySum += (cleanPrices[i-1] - cleanPrices[i]) / cleanPrices[i-1];
			const avgNavDecay = decaySum / (cleanPrices.length-1);

			// Dividends
			let rawDivs = [];
			if (divData.chart.result[0].events && divData.chart.result[0].events.dividends) {
				rawDivs = Object.values(divData.chart.result[0].events.dividends).sort((a,b) => a.date - b.date);
			}

			// Calc Div Stats
			let distRate = 0, distDecay = 0, unit = 'week', interval = 1;
			if(rawDivs.length > 1) {
				// Frequency
				const daysSpan = (rawDivs[rawDivs.length-1].date - rawDivs[0].date) / 86400;
				const avgGap = daysSpan / (rawDivs.length - 1);
				
				if(avgGap > 80) { unit = 'quarter'; interval = 13; }
				else if(avgGap > 25) { unit = 'month'; interval = 4; }
				else if(avgGap > 10) { unit = 'biweek'; interval = 2; }
				
				// Yield (vs Price at time of div)
				let rateSum = 0;
				rawDivs.forEach(d => {
					// Find closest price
					const closestIdx = cleanTimes.reduce((prev, curr, i) => 
						Math.abs(curr - d.date) < Math.abs(cleanTimes[prev] - d.date) ? i : prev, 0);
					rateSum += (d.amount / cleanPrices[closestIdx]);
				});
				distRate = rateSum / rawDivs.length;

				// Dist Decay (change in amount)
				let dDecaySum = 0;
				for(let i=1; i<rawDivs.length; i++) {
					if(rawDivs[i-1].amount > 0) dDecaySum += (rawDivs[i-1].amount - rawDivs[i].amount)/rawDivs[i-1].amount;
				}
				// Normalize decay to weekly
				const distDecayPerPeriod = dDecaySum / (rawDivs.length - 1);
				distDecay = distDecayPerPeriod / (avgGap/7); 
			}

			analysisTemp = {
				sym,
				prices: cleanPrices,
				times: cleanTimes,
				divs: rawDivs,
				navDecay: avgNavDecay,
				distRate,
				distDecay,
				interval,
				unit
			};

			status.innerHTML = `
				<div class="analysis-results">
					<strong>${sym} Analysis (${cleanPrices.length} wks)</strong>
					<div class="metric-row"><span>NAV Decay:</span> <span style="color:#2563eb">${(avgNavDecay*100).toFixed(3)}%/wk</span></div>
					<div class="metric-row"><span>Dist Rate:</span> <span style="color:#16a34a">${(distRate*100).toFixed(3)}%/${unit}</span></div>
					<div class="metric-row"><span>Yield Decay:</span> <span>${(distDecay*100).toFixed(3)}%/wk</span></div>
					<div class="history-badge">Ready to Apply</div>
				</div>`;
			
			btns[1].disabled = false;
			btns[2].disabled = false;

		} catch (e) {
			status.innerHTML = `<div class="error">Error: ${e.message}</div>`;
		} finally {
			btns[0].disabled = false;
		}
	}

	function applyToETF(id) {
		if(!analysisTemp) return;
		
		// Set Inputs
		document.getElementById(`etf${id}-nav-decay`).value = (analysisTemp.navDecay * 100).toFixed(3);
		document.getElementById(`etf${id}-dist-rate`).value = (analysisTemp.distRate * 100).toFixed(3);
		document.getElementById(`etf${id}-dist-decay`).value = (analysisTemp.distDecay * 100).toFixed(3);
		
		// Update Labels
		document.querySelector(`#etf${id}-rate-wrap label`).innerText = `Dist Rate (%/${analysisTemp.unit})`;
		document.querySelector(`#etf${id}-abs-wrap label`).innerText = `Abs Dist (%/${analysisTemp.unit})`;
		
		// Store Data
		etfConfig[`etf${id}`].name = analysisTemp.sym;
		etfConfig[`etf${id}`].interval = analysisTemp.interval;
		etfConfig[`etf${id}`].unit = analysisTemp.unit;
		document.getElementById(`etf${id}-name`).innerText = analysisTemp.sym;
		
		// Store History Data
		histData[`etf${id}`] = {
			prices: [...analysisTemp.prices], // Weekly Closes
			times: [...analysisTemp.times],   // Unix Timestamps
			divs: [...analysisTemp.divs]      // {date, amount}
		};

		calculate();
	}

	// --- Core Logic ---
	function calculate() {
		const inv = parseFloat(document.getElementById('initial-investment').value) || 10000;
		const weeks = parseInt(document.getElementById('timeframe').value) || 52;
		const showHist = document.getElementById('show-history').checked;
		const warning = document.getElementById('history-warning');

		// 1. Determine History Range
		let histLen = 0;
		let useHistory = false;
		
		if (showHist) {
			const h1 = histData.etf1 ? histData.etf1.prices.length : 0;
			const h2 = histData.etf2 ? histData.etf2.prices.length : 0;
			if (h1 > 0 || h2 > 0) {
				useHistory = true;
				// Min Range if both exist, otherwise max of whatever exists
				if (h1 > 0 && h2 > 0) histLen = Math.min(h1, h2);
				else histLen = Math.max(h1, h2);
			}
		}
		warning.style.display = (showHist && !useHistory) ? 'block' : 'none';

		// 2. Prepare Data Structure
		// X-Axis: -histLen ... 0 ... weeks
		const labels = [];
		for(let i = -histLen; i <= weeks; i++) labels.push(i);

		// Helper to calculate one ETF
		const calcETF = (id, historyObj, colorSet) => {
			const cfg = etfConfig[`etf${id}`];
			const navDecay = parseFloat(document.getElementById(`etf${id}-nav-decay`).value)/100 || 0;
			const distRate = parseFloat(document.getElementById(`etf${id}-dist-rate`).value)/100 || 0;
			const distDecay = parseFloat(document.getElementById(`etf${id}-dist-decay`).value)/100 || 0;
			const decouple = document.getElementById(`etf${id}-decouple`).checked;
			const absDist = parseFloat(document.getElementById(`etf${id}-abs-dist`).value)/100 || 0;

			// Arrays aligned to labels
			const dataNav = [];
			const dataInc = [];
			const dataDrip = [];

			// --- Phase A: History (-histLen to 0) ---
			let currNav = inv;
			let currInc = 0;
			let currDripShares = inv; // Tracking value of DRIP if we started with `inv` worth of shares
			let dripSharesCount = 0; // Actual share count for drip logic? 
			// Simpler DRIP: Value = Shares * Price. Start Shares = Inv / StartPrice.
			
			// If we have history for this ETF
			const hasHist = useHistory && historyObj;
			
			if (hasHist) {
				const prices = historyObj.prices;
				const divs = historyObj.divs;
				const startIdx = prices.length - histLen; // Index in raw data where backtest starts
				
				// Normalize: Start Value = Investment
				const startPrice = prices[startIdx];
				let shares = inv / startPrice;
				let dripShares = inv / startPrice; // For DRIP calculation
				
				// Push start point (-histLen)
				dataNav.push(inv);
				dataInc.push(0);
				dataDrip.push(inv);

				// Loop from -histLen+1 to 0
				for (let i = 1; i <= histLen; i++) {
					const rawIdx = startIdx + i;
					const price = prices[rawIdx];
					if (price === undefined) { 
						// Fallback if array mismatch
						dataNav.push(null); dataInc.push(null); dataDrip.push(null); 
						continue; 
					}

					// Check for dividends in this week (roughly)
					// We match divs that occurred between time[rawIdx-1] and time[rawIdx]
					const tStart = historyObj.times[rawIdx-1];
					const tEnd = historyObj.times[rawIdx];
					
					// Sum dividends in this window
					let divAmt = 0;
					divs.forEach(d => {
						if (d.date > tStart && d.date <= tEnd) divAmt += d.amount;
					});

					// Update Cash (Income)
					const weeklyIncome = divAmt * shares;
					currInc += weeklyIncome;

					// Update DRIP
					const dripIncome = divAmt * dripShares;
					dripShares += (dripIncome / price);

					// Current Values
					currNav = shares * price;
					
					dataNav.push(currNav);
					dataInc.push(currInc);
					dataDrip.push(dripShares * price);
				}
			} else {
				// No history: Pad nulls until 0
				for (let i = 0; i < histLen; i++) {
					dataNav.push(null); dataInc.push(null); dataDrip.push(null);
				}
				// At 0 (Today), start at Investment
				dataNav.push(inv);
				dataInc.push(0);
				dataDrip.push(inv);
			}

			// --- Phase B: Projection (1 to weeks) ---
			// Start from the last values calculated in Phase A
			let pNav = dataNav[dataNav.length-1];
			let pInc = dataInc[dataInc.length-1];
			let pDrip = dataDrip[dataDrip.length-1];
			
			// For projection, we simulate 'Shares' abstractly or just Value decay
			// Standard decay model: Value * (1 - decay)
			
			for (let w = 1; w <= weeks; w++) {
				// Calculate Distribution
				let distAmount = 0;
				if (w % cfg.interval === 0) {
					const decayFactor = Math.pow(1 - distDecay, w);
					if (decouple) {
						distAmount = (absDist * decayFactor) * inv; // Fixed % of initial? Or current? Usually initial in these tools unless specified
					} else {
						distAmount = pNav * (distRate * decayFactor);
					}
				}

				pInc += distAmount;
				
				// DRIP: Add dist to value
				pDrip += distAmount; // Simple accumulation + growth? 
				// Better DRIP Projection: Value grows by Dist, then decays
				// pDrip (before decay) += Dist. Then pDrip decays.
				// But Nav Decay removes value. Dist adds value.
				
				// Update NAV (Decay)
				pNav *= (1 - navDecay);
				pDrip *= (1 - navDecay); // Apply NAV decay to DRIP pool too

				dataNav.push(pNav);
				dataInc.push(pInc);
				dataDrip.push(pDrip);
			}

			return { nav: dataNav, inc: dataInc, drip: dataDrip };
		};

		// 3. Compute
		const res1 = calcETF(1, histData.etf1, C.e1);
		const res2 = calcETF(2, histData.etf2, C.e2);

		// 4. Update Summary
		const final1 = {
			valToday: res1.nav[histLen],
			nav: res1.nav[res1.nav.length-1],
			inc: res1.inc[res1.inc.length-1],
			drip: res1.drip[res1.drip.length-1]
		};
		const final2 = {
			valToday: res2.nav[histLen],
			nav: res2.nav[res2.nav.length-1],
			inc: res2.inc[res2.inc.length-1],
			drip: res2.drip[res2.drip.length-1]
		};

		// ETF 1 DOM
		document.getElementById('etf1-val-today').innerText = `$${final1.valToday.toLocaleString(undefined, {maximumFractionDigits:0})}`;
		document.getElementById('etf1-final-nav').innerText = `$${final1.nav.toLocaleString(undefined, {maximumFractionDigits:0})}`;
		document.getElementById('etf1-total-inc').innerText = `$${final1.inc.toLocaleString(undefined, {maximumFractionDigits:0})}`;
		document.getElementById('etf1-drip').innerText = `$${final1.drip.toLocaleString(undefined, {maximumFractionDigits:0})}`;
		document.getElementById('etf1-total-return').innerText = `$${(final1.nav + final1.inc).toLocaleString(undefined, {maximumFractionDigits:0})}`;

		// ETF 2 DOM
		document.getElementById('etf2-val-today').innerText = `$${final2.valToday.toLocaleString(undefined, {maximumFractionDigits:0})}`;
		document.getElementById('etf2-final-nav').innerText = `$${final2.nav.toLocaleString(undefined, {maximumFractionDigits:0})}`;
		document.getElementById('etf2-total-inc').innerText = `$${final2.inc.toLocaleString(undefined, {maximumFractionDigits:0})}`;
		document.getElementById('etf2-drip').innerText = `$${final2.drip.toLocaleString(undefined, {maximumFractionDigits:0})}`;
		document.getElementById('etf2-total-return').innerText = `$${(final2.nav + final2.inc).toLocaleString(undefined, {maximumFractionDigits:0})}`;

		// Delta
		const dInc = ((final1.inc / final2.inc) - 1) * 100;
		const dRet = (((final1.nav+final1.inc) / (final2.nav+final2.inc)) - 1) * 100;
		const dDrip = ((final1.drip / final2.drip) - 1) * 100;

		const fmtDelta = (val, el) => {
			const txt = (val > 0 ? '+' : '') + val.toFixed(1) + '%';
			el.innerText = txt;
			el.style.color = val > 0 ? '#166534' : (val < 0 ? '#991b1b' : '#333');
		};

		fmtDelta(dInc, document.getElementById('delta-inc'));
		fmtDelta(dRet, document.getElementById('delta-ret'));
		fmtDelta(dDrip, document.getElementById('delta-drip'));

		// 5. Render Chart
		chart.data.labels = labels;
		chart.data.datasets = [
			// ETF 1
			{ label: `${etfConfig.etf1.name} Value`, data: res1.nav, borderColor: C.e1.nav, borderWidth: 3, pointRadius: 0, tension: 0.1 },
			{ label: `${etfConfig.etf1.name} Income`, data: res1.inc, borderColor: C.e1.inc, backgroundColor: C.e1.inc, fill: true, pointRadius: 0, borderWidth: 1 },
			{ label: `${etfConfig.etf1.name} DRIP`, data: res1.drip, borderColor: C.e1.drip, borderWidth: 2, borderDash: [2,2], pointRadius: 0 },
			// ETF 2
			{ label: `${etfConfig.etf2.name} Value`, data: res2.nav, borderColor: C.e2.nav, borderWidth: 3, pointRadius: 0, tension: 0.1 },
			{ label: `${etfConfig.etf2.name} Income`, data: res2.inc, borderColor: C.e2.inc, backgroundColor: C.e2.inc, fill: true, pointRadius: 0, borderWidth: 1 },
			{ label: `${etfConfig.etf2.name} DRIP`, data: res2.drip, borderColor: C.e2.drip, borderWidth: 2, borderDash: [2,2], pointRadius: 0 }
		];
		
		// Annotation update
		chart.options.plugins.annotation.annotations.histZone.display = useHistory;
		chart.update();

		updateUrl();
	}

	// --- Utilities ---
	const debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };
	const runCalc = debounce(calculate, 200);

	// Events
	['timeframe', 'initial-investment', 'show-history'].forEach(id => document.getElementById(id).addEventListener('change', runCalc));
	['etf1-decouple', 'etf1-nav-decay', 'etf1-dist-rate', 'etf1-dist-decay', 'etf1-abs-dist',
	 'etf2-decouple', 'etf2-nav-decay', 'etf2-dist-rate', 'etf2-dist-decay', 'etf2-abs-dist']
	 .forEach(id => document.getElementById(id).addEventListener('input', runCalc));
	
	// Visibility Toggles
	document.getElementById('etf1-decouple').addEventListener('change', (e) => {
		document.getElementById('etf1-rate-wrap').classList.toggle('hidden', e.target.checked);
		document.getElementById('etf1-abs-wrap').classList.toggle('hidden', !e.target.checked);
	});
	document.getElementById('etf2-decouple').addEventListener('change', (e) => {
		document.getElementById('etf2-rate-wrap').classList.toggle('hidden', e.target.checked);
		document.getElementById('etf2-abs-wrap').classList.toggle('hidden', !e.target.checked);
	});

	// Date Init
	const d = new Date();
	document.getElementById('end-date').value = d.toISOString().split('T')[0];
	d.setMonth(d.getMonth()-12);
	document.getElementById('start-date').value = d.toISOString().split('T')[0];

	// URL State
	function updateUrl() {
		const p = new URLSearchParams();
		// Globals
		p.set('inv', document.getElementById('initial-investment').value);
		p.set('wks', document.getElementById('timeframe').value);
		p.set('hist', document.getElementById('show-history').checked);
		
		// ETF 1
		p.set('n1', etfConfig.etf1.name);
		p.set('nd1', document.getElementById('etf1-nav-decay').value);
		p.set('dr1', document.getElementById('etf1-dist-rate').value);
		p.set('dd1', document.getElementById('etf1-dist-decay').value);
		p.set('dc1', document.getElementById('etf1-decouple').checked);
		
		// ETF 2
		p.set('n2', etfConfig.etf2.name);
		p.set('nd2', document.getElementById('etf2-nav-decay').value);
		p.set('dr2', document.getElementById('etf2-dist-rate').value);
		p.set('dd2', document.getElementById('etf2-dist-decay').value);
		p.set('dc2', document.getElementById('etf2-decouple').checked);

		window.history.replaceState({}, '', `?${p.toString()}`);
	}

	function loadUrl() {
		const p = new URLSearchParams(window.location.search);
		if(!p.has('inv')) return;

		document.getElementById('initial-investment').value = p.get('inv');
		document.getElementById('timeframe').value = p.get('wks');
		document.getElementById('show-history').checked = p.get('hist') === 'true';

		// Load 1
		if(p.has('n1')) {
			etfConfig.etf1.name = p.get('n1');
			document.getElementById('etf1-name').innerText = p.get('n1');
		}
		document.getElementById('etf1-nav-decay').value = p.get('nd1');
		document.getElementById('etf1-dist-rate').value = p.get('dr1');
		document.getElementById('etf1-dist-decay').value = p.get('dd1');
		if(p.get('dc1') === 'true') document.getElementById('etf1-decouple').click();

		// Load 2
		if(p.has('n2')) {
			etfConfig.etf2.name = p.get('n2');
			document.getElementById('etf2-name').innerText = p.get('n2');
		}
		document.getElementById('etf2-nav-decay').value = p.get('nd2');
		document.getElementById('etf2-dist-rate').value = p.get('dr2');
		document.getElementById('etf2-dist-decay').value = p.get('dd2');
		if(p.get('dc2') === 'true') document.getElementById('etf2-decouple').click();
	}

	function shareUrl() {
		navigator.clipboard.writeText(window.location.href);
		document.getElementById('share-msg').innerText = 'URL Copied!';
		setTimeout(()=>document.getElementById('share-msg').innerText='', 2000);
	}

	// Init
	loadUrl();
	calculate();

</script>
</body>
</html>
